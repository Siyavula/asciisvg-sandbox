/* ==========================================================================================
SCG Library
Author: Leen Remmelzwaal
Date: 3rd August 2012

===================================
Method behind creating SVG image
===================================

Step 1: Create an SVG element: 							document.createElementNS("http://www.w3.org/2000/svg",element);
Step 2: Set attribute of the SVG element:  	element.setAttribute(attribute,value);
Step 3: Append SVG elements to SVG canvas: 	canvas.appendChild(element);
Step 4: Replace old SVG canvas with new:		svg_old.parentNode.replaceChild(svg_new,svg_old);

========================================================================================== */

// ==============================
// Variables
// ==============================

// Object Variables
var svg_picture, svg_new;

// Canvas Variables
var xmin = defaultxmin 								= -5;
var xmax = defaultxmax 								= 5;
var ymin = defaultymin 								= -5;
var ymax = defaultymax 								= 5;
var xscl = defaultxscl 								= 1;
var yscl = defaultyscl 								= 1;
var xgrid = defaultyscl 							= 1;
var ygrid = defaultygrid 							= 1;
var xtick = defaultxtick 							= 4;
var ytick = defaultytick 							= 4;
var border = defaultborder 						= 0;
var height = defaultwidth 						= 400;
var width = defaultheight 						= 400;
var xunitlength = defaultxunitlength 	= 1;
var yunitlength = defaultyunitlength 	= 1;
var origin = defaultorigin 						= [0,0];

// Element Variables
var axesstroke = defaultaxesstroke 						= "black";
var gridstroke = defaultgridstroke 						= "grey";
var strokewidth = defaultstrokewidth 					= 1; 					
var strokedasharray = defaultstrokedasharray 	= 1;
var stroke = defaultstroke 										= "black";
var arrowfill = defaultarrowfill 							= stroke;
var fill = defaultfill 												= "none";
var fontstyle = defaultfontstyle 							= "italic";
var fontfamily = defaultfontfamily 						= "times";		
var fontsize = defaultfontsize 								= 16;
var fontweight = defaultfontweight 						= "normal";
var fontstroke = defaultfontstroke 						= "none";
var fontfill = defaultfontfill 								= "none";    
var markerfill = defaultmarkerstrokewidth 		= 1;
var markerstroke = defaultmarkerstroke 				= "black";
var markerfill = defaultmarkerfill 						= "yellow";
var markersize = defaultmarkersize 						= 4;
var marker = defaultmarker 										= "none";
var dotradius = defaultdotradius 							= 4;
var ticklength = defaultticklength 						= 4;

// SVG Labels
var above = "above"; var below = "below"; var left = "left"; var right = "right"; var aboveleft = "aboveleft"; var aboveright = "aboveright"; var belowleft = "belowleft"; var belowright = "belowright";

// SVG Function Variables
var cpi = "\u03C0", ctheta = "\u03B8"; var pi = Math.PI, ln = Math.log, e = Math.E; var sign = function(x) { return (x==0?0:(x<0?-1:1)) }; var arcsin = Math.asin; var arccos = Math.acos; var arctan = Math.atan; var sinh = function(x) { return (Math.exp(x)-Math.exp(-x))/2 }; var cosh = function(x) { return (Math.exp(x)+Math.exp(-x))/2 }; var tanh = function(x) { return (Math.exp(x)-Math.exp(-x))/(Math.exp(x)+Math.exp(-x)) }; var arcsinh = function(x) { return ln(x+Math.sqrt(x*x+1)) }; var arccosh = function(x) { return ln(x+Math.sqrt(x*x-1)) }; var arctanh = function(x) { return ln((1+x)/(1-x))/2 }; var sech = function(x) { return 1/cosh(x) }; var csch = function(x) { return 1/sinh(x) }; var coth = function(x) { return 1/tanh(x) }; var arcsech = function(x) { return arccosh(1/x) }; var arccsch = function(x) { return arcsinh(1/x) }; var arccoth = function(x) { return arctanh(1/x) }; var sec = function(x) { return 1/Math.cos(x) }; var csc = function(x) { return 1/Math.sin(x) }; var cot = function(x) { return 1/Math.tan(x) }; var arcsec = function(x) { return arccos(1/x) }; var arccsc = function(x) { return arcsin(1/x) }; var arccot = function(x) { return arctan(1/x) };

// ==============================
// Functions (SVG VARIABLES)
// ==============================

function reset_variables()
{

// SVG Layout
xmin = defaultxmin;	xmax = defaultxmax;	ymin = defaultymin;	ymax = defaultymax;	xscl = defaultxscl;	yscl = defaultyscl; xgrid = defaultyscl;	ygrid = defaultygrid;	xtick = defaultxtick;	ytick = defaultytick;	border = defaultborder;	height = defaultwidth;	width = defaultheight;	xunitlength = defaultxunitlength; yunitlength = defaultyunitlength;	origin = defaultorigin;

// SVG Constant Variables
axesstroke = defaultaxesstroke;	gridstroke = defaultgridstroke;	strokewidth = defaultstrokewidth; strokedasharray = defaultstrokedasharray = null;	stroke = defaultstroke;	fill = defaultfill;	fontstyle = defaultfontstyle;	fontfamily = defaultfontfamily;	fontsize = defaultfontsize; fontweight = defaultfontweight;	fontstroke = defaultfontstroke;	fontfill = defaultfontfill; markerfill = defaultmarkerstrokewidth;	markerstroke = defaultmarkerstroke;	markerfill = defaultmarkerfill;	markersize = defaultmarkersize;	marker = defaultmarker;	arrowfill = defaultarrowfill; dotradius = defaultdotradius;	ticklength = defaultticklength;

}

// ==============================
// Functions (SVG CANVAS)
// ==============================

function setBorder(x, color) 
{ 
	// Set Variables
	if (x != null) 			{border = x;}
	if (color != null) 	{stroke = color;}
}

function initPicture(a,b,c,d)
{
	// Set Variables
	if (a != null) 	{xmin = a;}
	if (b != null) 	{xmax = b;}
	if (c != null) 	{ymin = c;}
	if (d != null) 	{ymax = d;}

	// Re-calculate variables
	xunitlength = (width-2*border)/(xmax-xmin);
  yunitlength = (height-2*border)/(ymax-ymin);
	origin = [-xmin*xunitlength+border,-ymin*yunitlength+border];

	if (svg_picture == null)
	{
		svg_picture = myCreateElementSVG("svg");
		svg_picture.setAttribute("id","picture1");
		document.getElementById('outputNode').appendChild(svg_picture);
		reset_variables(); // Reset Variables to original values for the next update	
	}
	else
	{
		// Initialize SVG Canvas
		svg_new = myCreateElementSVG("svg");
		svg_new.setAttribute("id","picture1");
		svg_new.setAttribute("style","display:inline");
		svg_new.setAttribute("width",width);
		svg_new.setAttribute("height",height);
		svg_new.setAttribute("xunitlength",xunitlength);
		svg_new.setAttribute("yunitlength",yunitlength);
		svg_new.setAttribute("xmin",xmin);
		svg_new.setAttribute("xmax",xmax);
		svg_new.setAttribute("ymin",ymin);
		svg_new.setAttribute("ymax",ymax);
		svg_new.setAttribute("ox", origin[0]);
		svg_new.setAttribute("oy", origin[1]);
	
		// Initialize blank background
		var node;
		node = myCreateElementSVG("rect");
		node.setAttribute("x","0");
		node.setAttribute("y","0");
		node.setAttribute("width",  width);
		node.setAttribute("height", height);
		node.setAttribute("stroke-width", border);
		node.setAttribute("stroke", stroke);
		node.setAttribute("fill", "white");
	
		// Append RECTANGLE to SVG
		svg_new.appendChild(node);

		// Append SVG to DIV (replace)
		svg_picture.parentNode.replaceChild(svg_new,svg_picture);

		// Replace old SVG object with new object
		svg_picture = svg_new; 
	}
}

function updatePicture()
{
	
	// Initialize Picture before user does
	initPicture();

	// Fetch code line-by-line
	var array_raw_code = document.getElementById("picture1input").value.split('\n');
	var array_len = array_raw_code.length;
	var error_text = "";
	
	for (i = 0; i < array_len; i++) {
		var line_raw_code = array_raw_code[i];
		
		// Formatting
		line_raw_code = line_raw_code.replace(/plot\(\x20*([^\"f\[][^\n\r]+?)\,/g,"plot\(\"$1\",");
		line_raw_code = line_raw_code.replace(/plot\(\x20*([^\"f\[][^\n\r]+)\)/g,"plot(\"$1\")");
		line_raw_code = line_raw_code.replace(/([0-9])([a-zA-Z])/g,"$1*$2");
		line_raw_code = line_raw_code.replace(/\)([\(0-9a-zA-Z])/g,"\)*$1");
		
		// Evaluate Functions
		try { with (Math) eval(line_raw_code); error_text += "";} 
		catch(err) { error_text += "<br>ERROR - " + line_raw_code + " (" + err + ")";	}
	}

	document.getElementById('error_msg').value = error_text; // Error Reporting
	reset_variables(); // Reset Variables to original values for the next update
}

// ==============================
// Functions (BASIC SVG ELEMENTS)
// ==============================

function myCreateElementSVG(t) {
	return document.createElementNS("http://www.w3.org/2000/svg",t);
}

function ASdot(center,radius,s,f) {
}

function dot(center, typ, label, pos, id) {
}

function arrowhead(p,q) {
}

function text(p,st,pos,id,fontsty) {

	// Default text positions
	var textanchor = "middle";
  var dx = 0; 
	var dy = fontsize/3;
	
	// Text Positions
  if (pos == aboveleft)	{dx = -fontsize/2; 	dy = -fontsize/2;		textanchor = "end";}
	if (pos == above)			{dx = 0; 						dy = -fontsize/2;		textanchor = "middle";}
	if (pos == aboveright){dx = fontsize/2; 	dy = -fontsize/2;		textanchor = "start";}
	if (pos == left)			{dx = -fontsize/2; 	dy = fontsize/3;		textanchor = "end";}
	if (pos == right)			{dx = fontsize/2; 	dy = fontsize/3;		textanchor = "start";}
	if (pos == belowleft)	{dx = -fontsize/2; 	dy = fontsize;			textanchor = "end";}
	if (pos == below)			{dx = 0; 						dy = fontsize;			textanchor = "middle";}
	if (pos == belowright){dx = fontsize/2; 	dy = fontsize;			textanchor = "start";}

	var node = myCreateElementSVG("text");
	node.appendChild(document.createTextNode(st));
  node.setAttribute("id", id);
  node.lastChild.nodeValue = st;
  node.setAttribute("x",p[0]*xunitlength+origin[0]+dx);
  node.setAttribute("y",height-p[1]*yunitlength-origin[1]+dy);
  node.setAttribute("font-style",(fontsty!=null?fontsty:fontstyle));
  node.setAttribute("font-family",fontfamily);
  node.setAttribute("font-size",fontsize);
  node.setAttribute("font-weight",fontweight);
  node.setAttribute("text-anchor",textanchor);
  if (fontstroke!="none") node.setAttribute("stroke",fontstroke);
  if (fontfill!="none") node.setAttribute("fill",fontfill);
	
  
	svg_picture.appendChild(node);
}

function mathjs(st) {
}

// ==============================
// Functions (COMPOUND SVG ELEMENTS)
// ==============================

function line(p,q,id) { /* DONE */
	var node = myCreateElementSVG("path");
	node.setAttribute("id", id);
	node.setAttribute("d","M"+(p[0]*xunitlength+origin[0])+","+
														(height-p[1]*yunitlength-origin[1])+" "+
														(q[0]*xunitlength+origin[0])+","+
														(height-q[1]*yunitlength-origin[1]));
	node.setAttribute("stroke-width", strokewidth);
  node.setAttribute("stroke", stroke);
  node.setAttribute("fill", fill);
	node.setAttribute("stroke-dasharray", strokedasharray);
	/* starting point (p) */
	if (marker=="dot" || marker=="arrowdot") {ASdot(p,markersize,markerstroke,markerfill); }
	/* ending point (q) */ 
	if (marker=="arrowdot" || marker=="arrow") {arrowhead(p,q);}
  if (marker=="dot") {ASdot(q,markersize,markerstroke,markerfill);}
	svg_picture.appendChild(node);
}

function ellipse(center,rx,ry,id) {  /* DONE */
  var node = myCreateElementSVG("ellipse");
  node.setAttribute("id", id);
  node.setAttribute("cx",center[0]*xunitlength+origin[0]);
  node.setAttribute("cy",height-center[1]*yunitlength-origin[1]);
  node.setAttribute("rx",rx*xunitlength);
  node.setAttribute("ry",ry*yunitlength);
  node.setAttribute("stroke-width", strokewidth);
  node.setAttribute("stroke", stroke);
  node.setAttribute("fill", fill);
	svg_picture.appendChild(node);
}

function circle(center,radius,id) {  /* DONE */
	ellipse(center,radius,radius,id);
}

function arc(start,end,radius,id) {
}

// ==============================
// Functions (COMPLEX SVG ELEMENTS)
// ==============================

function noaxes() {
}

function axes(dx,dy,labels,gdx,gdy) 
{



}

function grid(dx,dy) { /* DONE */
	axes(dx,dy,null,dx,dy)
}

function rect(p,q,id,rx,ry) { /* DONE */
	var node = myCreateElementSVG("rect");
	node.setAttribute("id", id);
	node.setAttribute("x",p[0]*xunitlength+origin[0]);
	node.setAttribute("y",height-q[1]*yunitlength-origin[1]);
	node.setAttribute("width",(q[0]-p[0])*xunitlength);
	node.setAttribute("height",(q[1]-p[1])*yunitlength);
	if (rx!=null) {node.setAttribute("rx",rx*xunitlength);}
	if (ry!=null) {node.setAttribute("ry",ry*yunitlength);}
	node.setAttribute("stroke-width", strokewidth);
	node.setAttribute("stroke", stroke);
	node.setAttribute("fill", fill);
	svg_picture.appendChild(node);
}

function path(plist,id,c) {
}

function plot(fun,x_min,x_max,points,id) {
}

function curve(plist,id) { /* DONE */
	path(plist,id,"T");
}

function loop(p,d,id) {
}

function slopefield(fun,dx,dy) {
}

// ================================================
// Additional functions
// Author: Leen Remmelzwaal
// Date: 14th June 2012
// ================================================

function fn_autocomplete() { /* DONE */
	if (document.getElementById("autocomplete_checkbox").checked) { updatePicture(); }
}



